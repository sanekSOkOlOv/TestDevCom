@model TestDevCom.Web.Models.Announcement
@using TestDevCom.Web.Enums
@using TestDevCom.Web.Models
@{
    ViewData["Title"] = "Редагувати оголошення";
}

<h2>Редагування оголошення</h2>

<form asp-action="Edit">
    <input type="hidden" asp-for="Id" />

    <div class="form-group">
        <label asp-for="Title"></label>
        <input asp-for="Title" class="form-control" />
        <span asp-validation-for="Title" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Category"></label>
        <select asp-for="Category" class="form-control" id="category">
            @foreach (var category in Enum.GetValues(typeof(Category)))
            {
                <option value="@((int)category)" selected="@(category.Equals(Model.Category) ? "selected" : null)">
                    @category
                </option>
            }
        </select>
    </div>

    <div class="form-group">
        <label asp-for="SubCategory"></label>
        <select asp-for="SubCategory" class="form-control" id="subcategory">
            <option>@Model.SubCategory</option>
        </select>
    </div>

    <div class="form-group">
        <label asp-for="Status">Статус</label>
        <select asp-for="Status" class="form-control">
            <option value="true" selected="@(Model.Status ? "selected" : null)">Активне</option>
            <option value="false" selected="@(Model.Status ? null : "selected")">Неактивне</option>
        </select>
    </div>

    <button type="submit" class="btn btn-primary">Зберегти</button>
    <a asp-action="Index" class="btn btn-secondary">Скасувати</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>

            document.addEventListener("DOMContentLoaded", function () {
            const categorySelect = document.getElementById("category");

            if (categorySelect && categorySelect.value) {
                categorySelect.dispatchEvent(new Event("change"));
            }
        });

        function formatEnumValue(value) {
            return value
                .replace(/_/g, ' ')
                .replace(/([a-zа-яґєії])([A-ZА-ЯҐЄІЇ])/g, '$1 $2');
        }

        document.addEventListener("DOMContentLoaded", function () {
            const categorySelect = document.getElementById("category");

            for (let option of categorySelect.options) {
                option.text = formatEnumValue(option.text);
            }
        });

        document.getElementById("category").addEventListener("change", async function () {
            const selectedCategory = this.value;
            const subcategorySelect = document.getElementById("subcategory");

            subcategorySelect.innerHTML = "<option disabled selected>Завантаження...</option>";

            try {
                const response = await fetch(`${apiBaseUrl}api/Category/subcategories/byid/${selectedCategory}`);


                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                subcategorySelect.innerHTML = "";

                if (data.length === 0) {
                    subcategorySelect.innerHTML = "<option disabled selected>Немає підкатегорій</option>";
                    return;
                }

                data.forEach(function (sub) {
                    const option = document.createElement("option");
                    option.value = sub;
                    option.text = formatEnumValue(sub);
                    subcategorySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Помилка отримання підкатегорій:", error);
                subcategorySelect.innerHTML = "<option disabled selected>Помилка завантаження</option>";
            }
        });
    </script>
}
