@model IEnumerable<TestDevCom.Web.Models.Announcement>
@using TestDevCom.Web.Enums
@using TestDevCom.Web.Models
@{
    ViewData["Title"] = "Оголошення";
}

<h2>@ViewData["Title"]</h2>

<a asp-action="Create" class="btn btn-primary mb-3">+ Додати оголошення</a>

<form asp-action="Index" method="get" class="mb-3">
    <div class="form-row">
        <div class="col">
            <select name="category" class="form-control" id="category-filter">
                <option value="">-- Виберіть категорію --</option>
                @foreach (Category cat in Enum.GetValues(typeof(Category)))
                {
                    var catInt = (int)cat;
                    var selected = ViewBag.SelectedCategory?.ToString() == cat.ToString() ? "selected" : "";
                    var catText = cat.ToString().Replace("_", " ");

                    @:<option value="@catInt" @selected>@catText</option>
                }
            </select>
        </div>
        <div class="col">
            <select name="subCategory" class="form-control" id="subcategory-filter">
                <option value="">-- Виберіть підкатегорію --</option>
            </select>
        </div>
        <div class="col">
            <button type="submit" class="btn btn-primary">Фільтрувати</button>
            <a asp-action="Index" class="btn btn-secondary">Очистити</a>
        </div>
    </div>
</form>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Назва</th>
            <th>Опис</th>
            <th>Категорія</th>
            <th>Підкатегорія</th>
			<th>Дата створення</th>
            <th>Статус</th>
            <th>Дії</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Title</td>
                <td>@item.Description</td>
                <td>@item.Category</td>
                <td>@item.SubCategory</td>
                <td>@item.CreatedDate</td>
                <td>@(item.Status ? "Активне" : "Неактивне")</td>
                <td>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">Редагувати</a>
                        <form asp-action="Delete" asp-route-id="@item.Id" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Ви впевнені?');">Видалити</button>
                        </form>
                    }
                    else
                    {
                        <span class="text-muted">Тільки для авторизованих</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
      
        function formatEnumValue(value) {
            return value
                .replace(/_/g, ' ')
                .replace(/([a-zа-яґєії])([A-ZА-ЯҐЄІЇ])/g, '$1 $2');
        }

        document.addEventListener("DOMContentLoaded", function () {
            const categorySelect = document.getElementById("category-filter");

            for (let option of categorySelect.options) {
                option.text = formatEnumValue(option.text); 
            }

            categorySelect.addEventListener("change", async function () {
                const selectedCategory = this.value; 
                const subcategorySelect = document.getElementById("subcategory-filter");

                subcategorySelect.innerHTML = "<option disabled selected>Завантаження...</option>";

                if (!selectedCategory) return;

                try {
                    const response = await fetch(`${apiBaseUrl}api/Category/subcategories/byid/${encodeURIComponent(selectedCategory)}`);


                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    subcategorySelect.innerHTML = "";

                    if (data.length === 0) {
                        subcategorySelect.innerHTML = "<option disabled selected>Немає підкатегорій</option>";
                        return;
                    }

                    subcategorySelect.innerHTML = '<option value="">-- Виберіть підкатегорію --</option>';

                    
                    data.forEach(function (sub) {
                        const option = document.createElement("option");
                        option.value = sub; 
                        option.text = formatEnumValue(sub);
                        subcategorySelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Помилка отримання підкатегорій:", error);
                    subcategorySelect.innerHTML = "<option disabled selected>Помилка завантаження</option>";
                }
            });
        });
    </script>
}



